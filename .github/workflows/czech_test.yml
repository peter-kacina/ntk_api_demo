name: Fetch Czech Repositories from re3data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'

jobs:
  fetch-czech-repos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Czech repositories
        run: |
          # Get Czech repos from beta API
          curl -s "https://www.re3data.org/api/beta/repositories?countries[]=AUS" -o czech_list.xml
          
          # Extract IDs
          grep -oP '(?<=<id>)r3d[0-9]+(?=</id>)' czech_list.xml > ids.txt
          
          echo "Found $(wc -l < ids.txt) Czech repositories"
          
          # CSV header
          echo 'id,name,url,content_types' > czech_repositories.csv
          
          # Fetch details for each
          while read -r id; do
            echo "Fetching $id..."
            xml=$(curl -s "https://www.re3data.org/api/beta/repository/${id}")
            
            # Use sed instead of grep for variable-length patterns
            name=$(echo "$xml" | sed -n 's/.*<r3d:repositoryName[^>]*>\([^<]*\)<.*/\1/p' | head -1 | sed 's/"/""/g')
            url=$(echo "$xml" | sed -n 's/.*<r3d:repositoryURL>\([^<]*\)<.*/\1/p' | head -1)
            content_types=$(echo "$xml" | sed -n 's/.*<r3d:contentType[^>]*>\([^<]*\)<.*/\1/p' | tr '\n' '|' | sed 's/|$//')
            
            echo "\"${id}\",\"${name}\",\"${url}\",\"${content_types}\"" >> czech_repositories.csv
            
            sleep 0.5
          done < ids.txt
          
          echo ""
          echo "=== Result ==="
          cat czech_repositories.csv

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: czech-repositories-csv
          path: czech_repositories.csv
          retention-days: 90

      - name: Commit CSV to repository
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add czech_repositories.csv || true
          git diff --staged --quiet || git commit -m "Update Czech repos $(date +'%Y-%m-%d')"
          git push || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
